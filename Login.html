<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skinship Beauty Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f7d4d0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      max-width: 1000px;
      width: 100%;
      display: flex;
      gap: 60px;
      align-items: center;
      justify-content: space-between;
      color: #2b2b2b;
    }

    .form-section {
      max-width: 450px;
      flex: 1;
    }

    .logo {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 300;
      font-size: 1.9rem;
      margin-bottom: 3px;
      letter-spacing: 0.05em;
      text-align: left;
      max-width: 160px;
      position: relative;
    }

    .logo svg {
      position: absolute;
      top: -32px;
      left: 0;
      width: 85px;
      height: 85px;
      stroke: #2b2b2b;
      fill: none;
      stroke-width: 1.7;
    }

    .welcome-text {
      font-weight: 800;
      color: #000000cc;
      margin-top: 0;
      font-size: 2.3rem;
      letter-spacing: 4px;
      font-family: 'Poppins', sans-serif;
      margin-bottom: 6px;
      user-select: none;
    }

    .subtext {
      font-size: 0.85rem;
      color: #000000cc;
      margin-bottom: 25px;
      user-select: none;
    }

    label {
      font-weight: 700;
      font-size: 1.05rem;
      display: block;
      margin-bottom: 5px;
      user-select: none;
    }

    input[type="email"],
    input[type="password"] {
      display: block;
      width: 100%;
      padding: 13px 15px;
      border: 1px solid #b89a96;
      border-radius: 15px;
      font-size: 1rem;
      color: #2b2b2b;
      background-color: #f7d4d0;
      outline-offset: 4px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      user-select: text;
    }

    input[type="email"]::placeholder,
    input[type="password"]::placeholder {
      color: #af9d99cc;
    }

    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: #da5c73;
      box-shadow: 0 0 10px #e88ea4cc;
      background-color: #fbe7eb;
    }

    .checkbox-group {
      margin-top: 10px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.82rem;
      color: #2b2b2bcc;
      user-select: none;
    }

    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #da5c73;
      cursor: pointer;
    }

    .forgot-password {
      margin-left: auto;
      font-weight: 700;
      font-size: 0.75rem;
      cursor: pointer;
      color: #2b2b2bcc;
      user-select: none;
      transition: color 0.25s ease;
    }

    .forgot-password:hover {
      color: #da5c73;
      text-decoration: underline;
    }

    button.signin-btn {
      width: 100%;
      padding: 14px 0;
      background-color: #da5c73;
      border: none;
      border-radius: 15px;
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: 1.8px;
      color: black;
      cursor: pointer;
      transition: background-color 0.35s ease;
      user-select: none;
    }

    button.signin-btn:hover {
      background-color: #e2798d;
    }

    button.signin-btn:disabled {
      background-color: #c4a5a8;
      cursor: not-allowed;
    }

    .image-section {
      width: 420px;
      height: 420px;
      border-radius: 50%;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 3px;
      box-shadow: 0 10px 25px rgb(0 0 0 / 0.15);
      user-select: none;
    }

    .image-section > div {
      overflow: hidden;
      position: relative;
    }
    .image-section > div img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transition: transform 0.4s ease;
    }

    .image-section > div:hover img {
      transform: scale(1.1);
    }

    .image-section > div:nth-child(2),
    .image-section > div:nth-child(3) {
      clip-path: polygon(0 0, 100% 100%, 0% 100%);
    }
    .image-section > div:nth-child(1),
    .image-section > div:nth-child(4) {
      clip-path: polygon(100% 0, 0 100%, 100% 100%);
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .warning-message {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }

    .warning-message.show {
      display: block;
    }
  </style>
</head>
<body>
  <main class="login-container">
    <section class="form-section" role="main" aria-label="Login Form Section">
      <div class="logo" aria-label="Skinship beauty logo">
        Skinship beauty
        <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
          <path d="M30 15 Q45 50 30 80 Q55 50 45 15" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h1 class="welcome-text">WELCOME BACK!</h1>
      <p class="subtext">Please enter your login details</p>
      <form id="loginForm">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Enter your email" required autocomplete="email" aria-required="true"/>
        
        <label for="password" class="mt-4">Password</label>
        <input id="password" name="password" type="password" placeholder="Enter your password" required autocomplete="current-password" aria-required="true"/>
        
        <div class="checkbox-group">
          <input type="checkbox" id="remember" name="remember" />
          <label for="remember" class="select-none">Remember me</label>
          <span class="forgot-password" onclick="window.location.href='forgotpassword.html'" role="link" tabindex="0" aria-label="Forgot password clickable text">Forgot password</span>
        </div>

        <button type="submit" class="signin-btn" aria-label="Sign in button">SIGN IN</button>
      </form>
      <div id="loginError" class="error-message"></div>
      <div id="loginWarning" class="warning-message"></div>
    </section>
    <section class="image-section" aria-label="Decorative beauty images">
      <div><img src="https://images.unsplash.com/photo-1587502536263-3e95976f7e34?auto=format&fit=crop&w=400&q=80" alt="Woman with perfectly shaped eyebrows receiving treatment"/></div>
      <div><img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80" alt="Close up of hands holding and manicured nails"/></div>
      <div><img src="https://images.unsplash.com/photo-1556229164-01c5e05a736e?auto=format&fit=crop&w=400&q=80" alt="Feet spa treatment with pedicure tools"/></div>
      <div><img src="https://images.unsplash.com/photo-1588776814546-355f5ee3ba8f?auto=format&fit=crop&w=400&q=80" alt="Man getting professional shaving and face spa treatment"/></div>
    </section>
  </main>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Yh7L4Wl9XRlOgxnzZyo8xxds6a02UJY",
      authDomain: "skinship-1ff4b.firebaseapp.com",
      projectId: "skinship-1ff4b",
      storageBucket: "skinship-1ff4b.firebasestorage.app",
      messagingSenderId: "963752770497",
      appId: "1:963752770497:web:8911cc6a375acdbdcc8d40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginForm = document.getElementById("loginForm");
    const errorMsg = document.getElementById("loginError");
    const warningMsg = document.getElementById("loginWarning");
    const submitBtn = loginForm.querySelector('button[type="submit"]');
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const rememberCheckbox = document.getElementById("remember");

    // Simple encoding for basic obfuscation (NOT for real security, just basic storage)
    function encodeData(str) {
      return btoa(str);
    }

    function decodeData(str) {
      try {
        return atob(str);
      } catch (e) {
        return null;
      }
    }

    // Load remembered credentials on page load
    function loadRememberedCredentials() {
      const savedEmail = localStorage.getItem('rememberedEmail');
      const savedPassword = localStorage.getItem('rememberedPassword');
      const wasRemembered = localStorage.getItem('rememberMe') === 'true';

      if (wasRemembered && savedEmail && savedPassword) {
        const decodedEmail = decodeData(savedEmail);
        const decodedPassword = decodeData(savedPassword);
        
        if (decodedEmail && decodedPassword) {
          emailInput.value = decodedEmail;
          passwordInput.value = decodedPassword;
          rememberCheckbox.checked = true;
        }
      }
    }

    // Save credentials if remember me is checked
    function saveCredentials(email, password, remember) {
      if (remember) {
        localStorage.setItem('rememberedEmail', encodeData(email));
        localStorage.setItem('rememberedPassword', encodeData(password));
        localStorage.setItem('rememberMe', 'true');
      } else {
        localStorage.removeItem('rememberedEmail');
        localStorage.removeItem('rememberedPassword');
        localStorage.removeItem('rememberMe');
      }
    }

    // Listen to checkbox changes to clear data if unchecked
    rememberCheckbox.addEventListener('change', (e) => {
      if (!e.target.checked) {
        localStorage.removeItem('rememberedEmail');
        localStorage.removeItem('rememberedPassword');
        localStorage.removeItem('rememberMe');
      }
    });

    // Load saved credentials when page loads
    loadRememberedCredentials();

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add("show");
      warningMsg.classList.remove("show");
      setTimeout(() => {
        errorMsg.classList.remove("show");
      }, 6000);
    }

    function showWarning(message) {
      warningMsg.textContent = message;
      warningMsg.classList.add("show");
      errorMsg.classList.remove("show");
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      errorMsg.classList.remove("show");
      warningMsg.classList.remove("show");
      submitBtn.disabled = true;
      submitBtn.textContent = "SIGNING IN...";

      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const remember = rememberCheckbox.checked;

      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const user = userCred.user;

        // Check if email is verified
        if (!user.emailVerified) {
          await auth.signOut();
          showWarning("⚠️ Please verify your email before logging in. Check your inbox for the verification link. Didn't receive it? Click below to resend.");
          
          // Add resend button
          const resendBtn = document.createElement('button');
          resendBtn.textContent = "Resend Verification Email";
          resendBtn.className = "signin-btn";
          resendBtn.style.marginTop = "10px";
          resendBtn.style.fontSize = "0.9rem";
          resendBtn.style.padding = "10px 0";
          resendBtn.onclick = async () => {
            try {
              await sendEmailVerification(user);
              showWarning("✅ Verification email sent! Please check your inbox.");
              resendBtn.remove();
            } catch (err) {
              showError("Failed to send verification email: " + err.message);
            }
          };
          
          if (!warningMsg.querySelector('button')) {
            warningMsg.appendChild(resendBtn);
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = "SIGN IN";
          return;
        }

        // Check if user exists in Firestore
        // ✅ Check if user exists in Firestore
const userDoc = await getDoc(doc(db, "users", user.uid));
if (userDoc.exists()) {
  const role = (userDoc.data().role || "").toLowerCase(); // make sure role is lowercase

  // Save credentials if remember me is checked
  saveCredentials(email, password, remember);

  // Store info locally for later use
  localStorage.setItem("currentUserEmail", email);
  localStorage.setItem("currentUserRole", role);

  if (role === "admin") {
  window.location.href = "dashboard.html";
  } else if (role === "staff") {
  window.location.href = "dashboard.html";
  } else {
  await auth.signOut();
  showError("❌ No valid role assigned. Contact system admin.");
  submitBtn.disabled = false;
  submitBtn.textContent = "SIGN IN";
  }
} else {
  await auth.signOut();
  showError("❌ No role assigned. Contact system admin.");
  submitBtn.disabled = false;
  submitBtn.textContent = "SIGN IN";
}

      } catch (error) {
        let errorMessage = "Login failed: ";
        
        switch (error.code) {
          case 'auth/invalid-email':
            errorMessage += "Invalid email address.";
            break;
          case 'auth/user-disabled':
            errorMessage += "This account has been disabled.";
            break;
          case 'auth/user-not-found':
            errorMessage += "No account found with this email.";
            break;
          case 'auth/wrong-password':
            errorMessage += "Incorrect password.";
            break;
          case 'auth/invalid-credential':
            errorMessage += "Invalid email or password.";
            break;
          default:
            errorMessage += error.message;
        }
        
        showError(errorMessage);
        submitBtn.disabled = false;
        submitBtn.textContent = "SIGN IN";
      }
    });
  </script>
  <script type="module" src="role-check.js"></script>

</body>
</html>