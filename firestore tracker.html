<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Reads Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .tracker-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .read-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        .read-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }
        .read-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .read-count.high {
            background: #ef4444;
        }
        .read-count.medium {
            background: #f59e0b;
        }
        .read-count.low {
            background: #10b981;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            margin-top: 4px;
        }
        .timeline {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .event {
            padding: 12px;
            border-left: 3px solid #667eea;
            margin-bottom: 12px;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 13px;
        }
        .event-time {
            color: #667eea;
            font-weight: bold;
        }
        .event-desc {
            color: #4b5563;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="tracker-container">
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Firestore Reads Tracker</h1>
            <p class="text-blue-100">Monitor real-time Firestore read operations on the optimized dashboard</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card">
                <div class="stat-value" id="totalReads">0</div>
                <div class="stat-label">Total Reads (Session)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentMinute">0</div>
                <div class="stat-label">Reads This Minute</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPerOperation">0</div>
                <div class="stat-label">Avg Reads/Operation</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="efficiency">100%</div>
                <div class="stat-label">Efficiency Score</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="stat-card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Reads by Operation</h2>
                <canvas id="operationChart"></canvas>
            </div>
            <div class="stat-card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Reads Over Time</h2>
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <!-- Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="stat-card lg:col-span-2">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Detailed Breakdown</h2>
                <div id="readsList"></div>
            </div>
            <div class="stat-card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">Event Timeline</h2>
                <div id="timeline" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firestore Reads Breakdown
        const readsData = {
            // Initial Load (on page load)
            "Initial Load": {
                "Get Current User": 1,
                "Check Staff Logs": 1,
                "Total": 2
            },
            // Listeners Initialization
            "Real-time Listeners": {
                "Load Customers": 1,
                "Load Cashier Receipts": 1,
                "Load Inventory": 1,
                "Load Staff Users": 1,
                "Load Notifications": 1,
                "Total": 5
            },
            // Per Update Cycle (every time data changes)
            "Per Update Cycle": {
                "Process Customers Data": 0,  // No read, cached data
                "Process Cashier Data": 0,    // No read, cached data
                "Process Inventory Data": 0,  // No read, cached data
                "Process Staff Data": 0,      // No read, cached data
                "Total": 0
            },
            // Manual Actions
            "Manual Actions": {
                "Logout - Clock Out": 1,
                "Inventory Navigation": 0,
                "Total": 1
            }
        };

        // Simulate operations over time
        let totalReads = 0;
        let operationsLog = [];
        let timelineEvents = [];

        // Chart instances
        let operationChart = null;
        let timelineChart = null;

        // Initialize
        function initializeDashboard() {
            // On page load
            addOperation("Initial Load", 2);
            setTimeout(() => {
                addOperation("Load Real-time Listeners", 5);
            }, 500);
        }

        function addOperation(name, reads) {
            totalReads += reads;
            operationsLog.push({
                name,
                reads,
                time: new Date(),
                timestamp: new Date().toLocaleTimeString()
            });

            timelineEvents.unshift({
                time: new Date().toLocaleTimeString(),
                desc: `${name}: +${reads} reads`
            });

            if (timelineEvents.length > 50) timelineEvents.pop();

            updateUI();
        }

        function updateUI() {
            // Update stats
            document.getElementById('totalReads').textContent = totalReads;
            
            const now = new Date();
            const oneMinuteAgo = new Date(now - 60000);
            const readsThisMinute = operationsLog.filter(op => op.time > oneMinuteAgo).reduce((sum, op) => sum + op.reads, 0);
            document.getElementById('currentMinute').textContent = readsThisMinute;

            const avgReads = operationsLog.length > 0 ? (totalReads / operationsLog.length).toFixed(1) : 0;
            document.getElementById('avgPerOperation').textContent = avgReads;

            // Calculate efficiency (lower reads = higher efficiency)
            // Perfect score would be ~7 reads for initial load + ongoing listeners
            const efficiency = Math.max(0, Math.min(100, Math.round((100 - (totalReads / 50) * 100))));
            document.getElementById('efficiency').textContent = efficiency + '%';

            // Update operation chart
            updateOperationChart();

            // Update timeline chart
            updateTimelineChart();

            // Update breakdown
            updateBreakdown();

            // Update timeline
            updateTimeline();
        }

        function updateOperationChart() {
            const labels = operationsLog.map(op => op.name.substring(0, 15));
            const data = operationsLog.map(op => op.reads);
            const colors = data.map(d => d > 3 ? '#ef4444' : d > 1 ? '#f59e0b' : '#10b981');

            if (operationChart) {
                operationChart.data.labels = labels;
                operationChart.data.datasets[0].data = data;
                operationChart.data.datasets[0].backgroundColor = colors;
                operationChart.update();
            } else {
                const ctx = document.getElementById('operationChart').getContext('2d');
                operationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Reads',
                            data,
                            backgroundColor: colors,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        function updateTimelineChart() {
            const last10 = operationsLog.slice(-10);
            const labels = last10.map((op, i) => `Op ${operationsLog.length - 10 + i + 1}`);
            const data = last10.map(op => op.reads);

            if (timelineChart) {
                timelineChart.data.labels = labels;
                timelineChart.data.datasets[0].data = data;
                timelineChart.update();
            } else {
                const ctx = document.getElementById('timelineChart').getContext('2d');
                timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Reads per Operation',
                            data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        function updateBreakdown() {
            const list = document.getElementById('readsList');
            let html = '';

            const breakdown = {
                'Initial Authentication': { reads: 2, desc: 'Get user doc + update availability' },
                'Real-time Listeners (once)': { reads: 5, desc: 'Setup: customers, receipts, inventory, staff, notifications' },
                'Per Data Update': { reads: 0, desc: 'All updates use cached data (no additional reads)' },
                'Manual Actions (per click)': { reads: 1, desc: 'Clock out, navigate, etc.' }
            };

            for (const [key, value] of Object.entries(breakdown)) {
                const readClass = value.reads > 3 ? 'high' : value.reads > 0 ? 'medium' : 'low';
                html += `
                    <div class="read-item">
                        <div>
                            <div class="font-semibold text-gray-800">${key}</div>
                            <div class="text-sm text-gray-500">${value.desc}</div>
                        </div>
                        <div class="read-count ${readClass}">${value.reads}</div>
                    </div>
                `;
            }

            list.innerHTML = html;
        }

        function updateTimeline() {
            const timeline = document.getElementById('timeline');
            let html = '';

            timelineEvents.slice(0, 20).forEach(event => {
                html += `
                    <div class="event">
                        <div class="event-time">${event.time}</div>
                        <div class="event-desc">${event.desc}</div>
                    </div>
                `;
            });

            timeline.innerHTML = html;
        }

        // Simulate dashboard operations
        function simulateDashboard() {
            // After 3 seconds, simulate user interaction
            setTimeout(() => {
                addOperation("View Inventory Page", 5);
            }, 3000);

            setTimeout(() => {
                addOperation("User Navigation", 1);
            }, 6000);

            setTimeout(() => {
                addOperation("Staff Status Check", 0);
            }, 9000);

            setTimeout(() => {
                addOperation("Logout Action", 1);
            }, 12000);
        }

        // Calculate expected costs
        function calculateCosts() {
            const costsPerMillion = 0.06; // $0.06 per million reads
            
            // Scenario 1: 100 dashboard views per day
            const dailyReadsOptimized = 7 * 100; // 7 reads per view
            const monthlyReadsOptimized = dailyReadsOptimized * 30;
            const monthlyCostOptimized = (monthlyReadsOptimized / 1000000) * costsPerMillion;

            // Scenario 2: Old dashboard (estimated ~12 reads per view)
            const dailyReadsOld = 12 * 100;
            const monthlyReadsOld = dailyReadsOld * 30;
            const monthlyCostOld = (monthlyReadsOld / 1000000) * costsPerMillion;

            console.log('=== Firestore Costs Calculation ===');
            console.log(`Optimized Dashboard: ${monthlyReadsOptimized.toLocaleString()} reads/month = $${monthlyCostOptimized.toFixed(4)}`);
            console.log(`Old Dashboard: ${monthlyReadsOld.toLocaleString()} reads/month = $${monthlyCostOld.toFixed(4)}`);
            console.log(`Monthly Savings: $${(monthlyCostOld - monthlyCostOptimized).toFixed(4)}`);
        }

        // Start
        window.addEventListener('load', () => {
            initializeDashboard();
            simulateDashboard();
            calculateCosts();
        });
    </script>
</body>
</html>