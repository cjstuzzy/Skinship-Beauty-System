<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skinship Beauty Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    .sidebar-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: #da5c73;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: .3s;
    }
    .sidebar-btn:hover {
      background: #da5c73;
      color: white;
      transform: scale(1.1);
    }
    .sidebar-btn.active {
      background: #da5c73;
      color: white;
    }
    .inventory-critical { background: #ffe6e6; border: 1px solid #ffb3b3; }
    .inventory-low { background: #fff4e6; border: 1px solid #ffd1a8; }
  </style>
</head>
<body class="bg-[#e6bfc7] min-h-screen flex w-full h-full">
  <!-- Sidebar -->
  <aside class="fixed top-0 left-0 w-20 bg-[#f7d4d0] flex flex-col items-center py-4 gap-2 shadow-lg rounded-r-3xl h-screen overflow-y-auto z-50">
    <div class="mb-6 mt-2">
      <i class="fa-solid fa-spa text-3xl text-[#da5c73]"></i>
    </div>
    <button class="sidebar-btn active" title="Dashboard" onclick="window.location.href='dashboard.html'"><i class="fa-solid fa-table-columns"></i></button>
    <button class="sidebar-btn" title="Reservations" onclick="window.location.href='calendar.html'"><i class="fa-solid fa-calendar-check"></i></button>
    <button class="sidebar-btn" title="Customers" onclick="window.location.href='customer.html'"><i class="fa-solid fa-users"></i></button>
    <button class="sidebar-btn" title="Staff" onclick="window.location.href='staff.html'"><i class="fa-solid fa-user-tie"></i></button>
    <button class="sidebar-btn" title="Services" onclick="window.location.href='services.html'"><i class="fa-solid fa-scissors"></i></button>
    <button class="sidebar-btn" title="Reports" onclick="window.location.href='sales.html'"><i class="fa-solid fa-chart-line"></i></button>
    <button class="sidebar-btn" title="Inventory" onclick="window.location.href='inventory.html'"><i class="fa-solid fa-box-open"></i></button>
    <button class="sidebar-btn" id="registrationBtn" title="Registration" onclick="window.location.href='Registration.html'"><i class="fa-solid fa-user-plus"></i></button>
    <button class="sidebar-btn" title="Cashier" onclick="window.location.href='Cashier.html'"><i class="fa-solid fa-cash-register"></i></button>
    <button class="sidebar-btn" title="Invoice" onclick="window.location.href='invoice.html'"><i class="fa-solid fa-file-invoice"></i></button>
    <button class="sidebar-btn" title="Purchase Order" onclick="window.location.href='purchase-order.html'"><i class="fa-solid fa-receipt"></i></button>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 w-full ml-20">
    <div class="bg-[#b97b8b] rounded-3xl p-6 shadow-lg relative h-full">
      <!-- Topbar -->
      <div class="flex justify-end items-center gap-4 mb-6">
        <i id="notificationBtn" class="fa-regular fa-bell text-xl cursor-pointer"></i>
        <span class="font-semibold text-lg" id="usernameDisplay">admin</span>
        <div class="relative">
          <button id="userMenuButton" onclick="document.getElementById('userMenu').classList.toggle('hidden')"><i class="fa-solid fa-user-circle text-2xl"></i></button>
          <div id="userMenu" class="hidden absolute right-0 mt-2 w-36 bg-white rounded shadow">
            <button class="w-full text-left px-3 py-2 hover:bg-gray-100" onclick="window.location.href='Login.html'">Logout</button>
          </div>
        </div>
      </div>

      <!-- Dashboard content -->
      <div class="grid grid-cols-12 gap-6">
        <!-- Completed -->
        <div class="col-span-3 bg-white rounded-lg shadow p-10 text-center h-30 justify-center">
          <p id="completedCount" class="text-green-600 font-bold text-lg">0</p>
          <div class="font-bold">Completed</div>
        </div>

        <!-- Pending -->
        <div class="col-span-3 bg-white rounded-lg shadow p-10 text-center h-30 justify-center">
          <p id="pendingCount" class="text-yellow-600 font-bold text-lg">00</p>
          <div class="font-bold">Pending</div>
        </div>

        <!-- Cancelled -->
        <div class="col-span-3 bg-white rounded-lg shadow p-10 text-center h-30 justify-center">
          <p id="cancelledCount" class="text-red-600 font-bold text-lg">00</p>
          <div class="font-bold">Cancelled</div>
        </div>
        
        <!-- Inventory Alerts -->
        <div class="col-span-3 bg-white rounded-lg shadow p-4">
          <h2 class="font-bold mb-2">Inventory Alerts</h2>
          <div id="inventoryList" class="space-y-2 text-sm"></div>
        </div>

        <!-- Reservation -->
        <div class="col-span-9 bg-white rounded-lg shadow p-4 h-80">
          <div class="flex justify-between items-center mb-5">
            <h2 class="font-bold">Reservation</h2>
            <a href="customer.html" class="text-sm text-rose-500">View all</a>
          </div>
          <table class="w-full text-sm">
            <thead class="text-left font-semibold">
              <tr>
                <th>Customer</th>
                <th>Time</th>
                <th>Status</th>
                <th>Service</th>
                <th>Staff</th>
              </tr>
            </thead>
            <tbody id="reservationTable">
              <tr>
                <td colspan="5" class="text-center text-gray-500 italic">Loading reservations...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Staff Availability -->
        <div class="col-span-3 bg-white rounded-lg shadow p-3">
          <h2 class="font-bold mb-2">Staff Availability</h2>
          <div id="staffAvailabilityList">
            <p class="text-gray-500 italic">Loading...</p>
          </div>
        </div>

        <!-- Top 3 Services Sold (Last 7 Days) -->
        <div class="col-span-3 bg-white rounded-lg shadow p-4">
          <h2 class="font-bold mb-3">Top 3 Services Sold (Last 7 Days)</h2>
          <div style="height: 180px; position: relative;">
            <canvas id="topServicesChart"></canvas>
          </div>
        </div>

        <!-- Revenue (by Weekday) Chart -->
        <div class="col-span-6 bg-white rounded-lg shadow p-4">
          <h2 class="font-bold mb-3">Revenue (by Weekday)</h2>
          <canvas id="revenueChart" style="max-height: 200px;"></canvas>
          <p id="revenueTotal" class="text-right font-bold text-rose-600">Total of: â‚±0.00</p>
        </div>

        <!-- Today's Agenda -->
        <div class="col-span-3 bg-white rounded-lg shadow p-4">
          <div class="flex justify-between items-center mb-2">
            <h2 class="font-bold">Today's Agenda</h2>
            <a href="calendar.html" class="text-sm text-rose-500">View all</a>
          </div>
          <ul id="agendaList" class="list-disc list-inside text-sm">
            <li class="text-gray-500 italic">Loading...</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      onSnapshot,
      orderBy
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2Yh7L4Wl9XRlOgxnzZyo8xxds6a02UJY",
      authDomain: "skinship-1ff4b.firebaseapp.com",
      projectId: "skinship-1ff4b",
      storageBucket: "skinship-1ff4b.appspot.com",
      messagingSenderId: "963752770497",
      appId: "1:963752770497:web:8911cc6a375acdbdcc8d40"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Role-based
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const data = userSnap.data();
            document.getElementById("usernameDisplay").textContent = data.username || data.fullName || user.email || "User";
            if (data.role !== "admin") {
              const regBtn = document.getElementById("registrationBtn");
              if (regBtn) regBtn.style.display = "none";
            }
          }
        } catch (err) {
          console.error("Error fetching user document:", err);
        }
      }
    });

    // Staff availability
    const staffAvailabilityList = document.getElementById("staffAvailabilityList");
    const staffQuery = query(collection(db, "users"), where("availability", "==", true));
    onSnapshot(staffQuery, (snapshot) => {
      staffAvailabilityList.innerHTML = "";
      if (snapshot.empty) {
        staffAvailabilityList.innerHTML = `<p class="text-gray-500 italic">No staff available</p>`;
        return;
      }
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const name = data.fullName || data.username || "Unnamed";
        const div = document.createElement("div");
        div.className = "bg-rose-100 p-2 rounded mb-2";
        div.textContent = name;
        staffAvailabilityList.appendChild(div);
      });
    });

    // Reservations list
    const reservationTable = document.getElementById("reservationTable");
    const reservationQuery = query(collection(db, "customers"), orderBy("createdAt", "desc"));
    onSnapshot(reservationQuery, (snapshot) => {
      reservationTable.innerHTML = "";
      if (snapshot.empty) {
        reservationTable.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 italic">No reservations found</td></tr>`;
        return;
      }
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const tr = document.createElement("tr");
        tr.className = "border-b";
        tr.innerHTML = `
          <td>${data.name || data.customer || "N/A"}</td>
          <td>${data.appointment || data.time || "N/A"}</td>
          <td>${(data.status || "Pending").charAt(0).toUpperCase() + (data.status || "Pending").slice(1)}</td>
          <td>${data.service || "N/A"}</td>
          <td>${data.staff || "N/A"}</td>
        `;
        reservationTable.appendChild(tr);
      });
    });

    // Today's agenda
    const agendaList = document.getElementById("agendaList");
    const todayISO = new Date().toISOString().split("T")[0];
    const apptQuery = query(collection(db, "customers"));
    onSnapshot(apptQuery, (snapshot) => {
      agendaList.innerHTML = "";
      const todays = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.date === todayISO && (data.status || '').toLowerCase() === 'pending') {
          todays.push(data);
        }
      });
      if (todays.length === 0) {
        agendaList.innerHTML = `<li class="text-gray-500 italic">No appointments today</li>`;
      } else {
        todays.sort((a,b) => (a.time||'').localeCompare(b.time||''));
        todays.forEach(a => {
          const li = document.createElement('li');
          li.textContent = `${a.time || '-'} - ${a.name || a.customer || 'Customer'} - ${a.service || '-'}`;
          agendaList.appendChild(li);
        });
      }
    });

    // Inventory Alerts
    const inventoryList = document.getElementById("inventoryList");
    onSnapshot(collection(db, "products"), (snapshot) => {
      inventoryList.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const productName = data.name || "Unnamed Product";
        const quantity = (typeof data.quantity !== "undefined") ? Number(data.quantity) : 0;

        if (quantity < 10) {
          const cls = quantity < 5 ? "inventory-critical" : "inventory-low";
          inventoryList.innerHTML += `
            <div class="${cls} p-2 rounded">
              <div class="font-semibold">${productName}</div>
              <div class="text-gray-600">Qty: ${quantity}</div>
            </div>
          `;
        }
      });

      if (!inventoryList.innerHTML) {
        inventoryList.innerHTML = `<p class="text-gray-500">All stocks are sufficient</p>`;
      }
    });

    // Revenue Chart + Completed Count
    const revenueTotal = document.getElementById("revenueTotal");
    const completedCountEl = document.getElementById("completedCount");
    
    let revenueChart = null;

    onSnapshot(collection(db, "cashier_receipt"), (snapshot) => {
      const totalsByDay = {
        "Monday": 0, "Tuesday": 0, "Wednesday": 0,
        "Thursday": 0, "Friday": 0, "Saturday": 0, "Sunday": 0
      };
      let grandTotal = 0;
      let completed = 0;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const cost = Number(data.subtotal || data.amount || data.price || data.total_cost || 0);

        if (data.subtotal || data.receiptNumber || data.payment) {
          completed++;
        }

        let day = null;
        if (data.day) {
          day = data.day;
        } else if (data.timestamp && typeof data.timestamp.toDate === "function") {
          const d = data.timestamp.toDate();
          day = d.toLocaleDateString("en-US", { weekday: "long" });
        } else if (data.createdAt) {
          try {
            if (typeof data.createdAt === "string") {
              const d = new Date(data.createdAt);
              if (!isNaN(d)) day = d.toLocaleDateString("en-US", { weekday: "long" });
            } else if (typeof data.createdAt.toDate === "function") {
              const d = data.createdAt.toDate();
              day = d.toLocaleDateString("en-US", { weekday: "long" });
            }
          } catch (e) {}
        }

        if (day && totalsByDay[day] !== undefined) {
          totalsByDay[day] += cost;
        }

        grandTotal += cost;
      });

      completedCountEl.textContent = completed.toString().padStart(2, "0");
      revenueTotal.textContent = `Total of: â‚±${grandTotal.toLocaleString("en-PH", {minimumFractionDigits: 2})}`;

      // Update Revenue Chart
      const daysOrder = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const revenueData = daysOrder.map(d => totalsByDay[d] || 0);

      if (revenueChart) {
        revenueChart.data.datasets[0].data = revenueData;
        revenueChart.update();
      } else {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: daysOrder,
            datasets: [{
              label: 'Revenue',
              data: revenueData,
              backgroundColor: '#f5a3b5',
              borderColor: '#da5c73',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'â‚±' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
      }
    });

    // Top 3 Services Sold (Last 7 Days)
    let topServicesChart = null;
    
    onSnapshot(collection(db, "cashier_receipt"), (snapshot) => {
      const serviceCounts = {};
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        let docDate = null;

        // Get date from timestamp or createdAt
        if (data.timestamp && typeof data.timestamp.toDate === "function") {
          docDate = data.timestamp.toDate();
        } else if (data.createdAt) {
          try {
            if (typeof data.createdAt === "string") {
              docDate = new Date(data.createdAt);
            } else if (typeof data.createdAt.toDate === "function") {
              docDate = data.createdAt.toDate();
            }
          } catch (e) {}
        } else if (data.date) {
          // Try to parse date field like "10/2/2025"
          try {
            docDate = new Date(data.date);
          } catch (e) {}
        }

        // Check if within last 7 days (or include all if no date found)
        if (!docDate || docDate >= sevenDaysAgo) {
          // Get items array from the receipt
          const items = data.items || [];
          items.forEach(item => {
            const name = item.name || "Unknown Service";
            serviceCounts[name] = (serviceCounts[name] || 0) + 1;
          });
        }
      });

      const sorted = Object.entries(serviceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      const labels = sorted.map(s => s[0]);
      const counts = sorted.map(s => s[1]);
      const colors = ['#5b9bd5', '#70ad47', '#ffc000'];

      if (topServicesChart) {
        topServicesChart.data.labels = labels;
        topServicesChart.data.datasets[0].data = counts;
        topServicesChart.data.datasets[0].backgroundColor = colors.slice(0, counts.length);
        topServicesChart.update();
      } else {
        const ctx = document.getElementById('topServicesChart').getContext('2d');
        topServicesChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Services Sold',
              data: counts,
              backgroundColor: colors,
              borderWidth: 0
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  precision: 0
                }
              }
            }
          }
        });
      }
    });

    // Pending / Cancelled counts
    onSnapshot(collection(db, "customers"), (snapshot) => {
      let pendingCount = 0;
      let cancelledCount = 0;
      snapshot.forEach(docSnap => {
        const s = (docSnap.data().status || '').toString().toLowerCase();
        if (s === 'pending') pendingCount++;
        if (s === 'cancelled' || s === 'canceled') cancelledCount++;
      });
      const pEl = document.getElementById("pendingCount");
      const cEl = document.getElementById("cancelledCount");
      if (pEl) pEl.textContent = pendingCount.toString().padStart(2, "0");
      if (cEl) cEl.textContent = cancelledCount.toString().padStart(2, "0");
    });

    // Close user menu
    window.addEventListener('click', (e) => {
      const userMenu = document.getElementById('userMenu');
      const btn = document.getElementById('userMenuButton');
      if (!btn.contains(e.target) && userMenu && !userMenu.contains(e.target)) {
        userMenu.classList.add('hidden');
      }
    });
  </script>
</body>
</html>